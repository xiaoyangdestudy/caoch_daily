# Coach Daily - äº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ğŸ¯ å¿«é€Ÿéƒ¨ç½²ï¼ˆ3æ­¥å®Œæˆï¼‰

### å‡†å¤‡å·¥ä½œ

ç¡®ä¿ä½ æœ‰ï¼š
- âœ… Ubuntu 20.04/22.04 äº‘æœåŠ¡å™¨
- âœ… æœåŠ¡å™¨IPåœ°å€
- âœ… SSHè®¿é—®æƒé™ï¼ˆrootç”¨æˆ·æˆ–sudoæƒé™ï¼‰

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

### Windowsç”¨æˆ·

æ‰“å¼€PowerShellæˆ–CMDï¼Œæ‰§è¡Œï¼š

```powershell
ssh root@YOUR_SERVER_IP
```

æ›¿æ¢ `YOUR_SERVER_IP` ä¸ºä½ çš„å®é™…æœåŠ¡å™¨IPã€‚

ä¾‹å¦‚ï¼š
```powershell
ssh root@123.45.67.89
```

**é¦–æ¬¡è¿æ¥**ä¼šè¯¢é—®æ˜¯å¦ä¿¡ä»»ï¼Œè¾“å…¥ `yes` å›è½¦ï¼Œç„¶åè¾“å…¥å¯†ç ã€‚

---

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šè¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬

è¿æ¥æˆåŠŸåï¼Œåœ¨æœåŠ¡å™¨ä¸Šä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. ä¸‹è½½éƒ¨ç½²è„šæœ¬
curl -o setup-server.sh https://raw.githubusercontent.com/xiaoyangdestudy/caoch_daily/main/server/setup-server.sh

# 2. æ·»åŠ æ‰§è¡Œæƒé™
chmod +x setup-server.sh

# 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
sudo bash setup-server.sh
```

### è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š

1. âœ… æ›´æ–°ç³»ç»Ÿ
2. âœ… å®‰è£…Node.js 18 LTS
3. âœ… å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
4. âœ… å®‰è£…Nginx
5. âœ… åˆ›å»ºåº”ç”¨ç”¨æˆ·
6. âœ… ä»GitHubå…‹éš†ä»£ç 
7. âœ… å®‰è£…é¡¹ç›®ä¾èµ–
8. âœ… é…ç½®ç¯å¢ƒå˜é‡ï¼ˆè‡ªåŠ¨ç”ŸæˆJWTå¯†é’¥ï¼‰
9. âœ… å¯åŠ¨æœåŠ¡
10. âœ… é…ç½®Nginxåå‘ä»£ç†
11. âœ… é…ç½®é˜²ç«å¢™

### äº¤äº’å¼é€‰é¡¹

è„šæœ¬ä¼šè¯¢é—®ï¼š
- **æ˜¯å¦é…ç½®Nginxï¼Ÿ** â†’ è¾“å…¥ `y` å›è½¦
- **æ˜¯å¦é…ç½®é˜²ç«å¢™ï¼Ÿ** â†’ è¾“å…¥ `y` å›è½¦

**æ•´ä¸ªè¿‡ç¨‹çº¦5-10åˆ†é’Ÿ**

---

## âœ… ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•API

éƒ¨ç½²å®Œæˆåï¼Œè®°ä¸‹æ˜¾ç¤ºçš„æœåŠ¡å™¨IPï¼Œç„¶åæµ‹è¯•ï¼š

### åœ¨æœ¬åœ°ç”µè„‘æµ‹è¯•

```powershell
# æ›¿æ¢ä¸ºä½ çš„å®é™…æœåŠ¡å™¨IP
curl http://YOUR_SERVER_IP/health
```

åº”è¯¥è¿”å›ï¼š
```json
{"status":"ok","timestamp":"...","environment":"production","version":"1.0.0"}
```

### æµ‹è¯•æ³¨å†ŒAPI

```powershell
curl -X POST http://YOUR_SERVER_IP/api/auth/register `
  -H "Content-Type: application/json" `
  -d '{"username":"testuser2","password":"test123456"}'
```

åº”è¯¥è¿”å›åŒ…å«tokençš„JSONã€‚

---

## ğŸ“± ç¬¬å››æ­¥ï¼šä¿®æ”¹Flutterå®¢æˆ·ç«¯APIåœ°å€

åœ¨ä½ çš„Flutteré¡¹ç›®ä¸­ï¼Œä¿®æ”¹APIåœ°å€ï¼š

### æ–‡ä»¶ï¼š`lib/shared/providers/api_provider.dart`

```dart
final apiClientProvider = Provider<ApiClient>((ref) {
  return ApiClient(
    // ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨IP
    baseUrl: 'http://YOUR_SERVER_IP/api',
  );
});
```

ä¾‹å¦‚ï¼š
```dart
baseUrl: 'http://123.45.67.89/api',
```

### é‡æ–°è¿è¡ŒFlutteråº”ç”¨

```bash
flutter run
```

ç°åœ¨å¯ä»¥åœ¨åº”ç”¨ä¸­ï¼š
1. è¿›å…¥"ä¸ªäººè®¾ç½®"
2. ç‚¹å‡»"ç™»å½•/æ³¨å†Œ"
3. æ³¨å†Œæ–°è´¦å·æˆ–ä½¿ç”¨testuserç™»å½•
4. æµ‹è¯•æ•°æ®åŒæ­¥åŠŸèƒ½

---

## ğŸ” å¸¸ç”¨ç®¡ç†å‘½ä»¤

### SSHåˆ°æœåŠ¡å™¨å

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - coach-daily

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs coach-daily-api

# é‡å¯æœåŠ¡
pm2 restart coach-daily-api

# åœæ­¢æœåŠ¡
pm2 stop coach-daily-api

# æŸ¥çœ‹NginxçŠ¶æ€
systemctl status nginx

# é‡å¯Nginx
sudo systemctl restart nginx
```

### æŸ¥çœ‹æ•°æ®åº“

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - coach-daily

# è¿›å…¥æ•°æ®åº“ç›®å½•
cd ~/coach-daily/server/data

# æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶
ls -lh coach_daily.db

# ä½¿ç”¨sqlite3æŸ¥çœ‹ï¼ˆéœ€è¦å…ˆå®‰è£…ï¼‰
sqlite3 coach_daily.db "SELECT * FROM users;"
```

---

## ğŸ”„ æ›´æ–°ä»£ç 

å½“ä½ ä¿®æ”¹äº†ä»£ç å¹¶æ¨é€åˆ°GitHubåï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°ï¼š

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - coach-daily

# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/coach-daily

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# è¿›å…¥æœåŠ¡å™¨ç›®å½•
cd server

# å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
npm install --production

# é‡å¯æœåŠ¡
pm2 restart coach-daily-api
```

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›ºï¼ˆæ¨èï¼‰

### 1. ä¿®æ”¹SSHç«¯å£

```bash
# ç¼–è¾‘SSHé…ç½®
sudo nano /etc/ssh/sshd_config

# æ‰¾åˆ° #Port 22ï¼Œä¿®æ”¹ä¸ºï¼š
Port 2222

# ä¿å­˜é€€å‡ºï¼ˆCtrl+X, Y, Enterï¼‰

# æ›´æ–°é˜²ç«å¢™
sudo ufw allow 2222/tcp
sudo ufw delete allow 22/tcp

# é‡å¯SSH
sudo systemctl restart sshd
```

ä»¥åè¿æ¥æ—¶ä½¿ç”¨ï¼š
```bash
ssh -p 2222 root@YOUR_SERVER_IP
```

### 2. ç¦ç”¨rootå¯†ç ç™»å½•ï¼ˆä½¿ç”¨å¯†é’¥ï¼‰

```bash
# ç¼–è¾‘SSHé…ç½®
sudo nano /etc/ssh/sshd_config

# ä¿®æ”¹ä»¥ä¸‹é€‰é¡¹ï¼š
PermitRootLogin prohibit-password
PasswordAuthentication no

# é‡å¯SSH
sudo systemctl restart sshd
```

### 3. å®‰è£…Fail2Bané˜²æš´åŠ›ç ´è§£

```bash
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

---

## ğŸ“Š ç›‘æ§ä¸å¤‡ä»½

### è®¾ç½®è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹ï¼‰

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - coach-daily

# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > ~/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="$HOME/backups"
DB_PATH="$HOME/coach-daily/server/data/coach_daily.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $DB_PATH $BACKUP_DIR/backup_$DATE.db

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.db" -mtime +7 -delete

echo "Backup completed: $DATE"
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x ~/backup.sh

# æ·»åŠ åˆ°crontab
(crontab -l 2>/dev/null; echo "0 3 * * * $HOME/backup.sh >> $HOME/backup.log 2>&1") | crontab -
```

### æŸ¥çœ‹ç³»ç»Ÿèµ„æº

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹è¿›ç¨‹
htop  # éœ€è¦å…ˆå®‰è£…: sudo apt install htop
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ— æ³•è®¿é—®API

**A**: æ£€æŸ¥é˜²ç«å¢™å’ŒNginx

```bash
# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status

# ç¡®ä¿80ç«¯å£å¼€æ”¾
sudo ufw allow 80/tcp

# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx

# é‡å¯Nginx
sudo systemctl restart nginx
```

### Q2: æœåŠ¡æ— æ³•å¯åŠ¨

**A**: æŸ¥çœ‹æ—¥å¿—

```bash
sudo su - coach-daily
pm2 logs coach-daily-api --err
```

### Q3: æ•°æ®åº“é”å®š

**A**: é‡å¯æœåŠ¡

```bash
sudo su - coach-daily
pm2 restart coach-daily-api
```

### Q4: ç«¯å£è¢«å ç”¨

**A**: æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ

```bash
sudo lsof -i :3000
# æˆ–
sudo netstat -tulnp | grep 3000
```

---

## ğŸŠ éƒ¨ç½²æˆåŠŸæ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨ä¸Š`pm2 status`æ˜¾ç¤ºåº”ç”¨running
- [ ] `curl http://YOUR_SERVER_IP/health`è¿”å›JSON
- [ ] `curl http://YOUR_SERVER_IP/api/auth/register`å¯ä»¥æ³¨å†Œç”¨æˆ·
- [ ] Flutteråº”ç”¨å¯ä»¥è¿æ¥æœåŠ¡å™¨API
- [ ] å¯ä»¥åœ¨åº”ç”¨ä¸­ç™»å½•å¹¶åŒæ­¥æ•°æ®
- [ ] é˜²ç«å¢™é…ç½®æ­£ç¡®
- [ ] è®¾ç½®äº†è‡ªåŠ¨å¤‡ä»½

---

## ğŸ“ è·å–æœåŠ¡å™¨IP

å¦‚æœå¿˜è®°äº†æœåŠ¡å™¨IPï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
curl ifconfig.me
# æˆ–
hostname -I
```

---

## ğŸ”„ å®Œæ•´é‡æ–°éƒ¨ç½²

å¦‚æœéœ€è¦ä»å¤´å¼€å§‹ï¼š

```bash
# åœæ­¢æœåŠ¡
sudo su - coach-daily
pm2 delete coach-daily-api
exit

# åˆ é™¤åº”ç”¨ç›®å½•
sudo rm -rf /home/coach-daily/coach-daily

# é‡æ–°è¿è¡Œéƒ¨ç½²è„šæœ¬
sudo bash setup-server.sh
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ã€ŠæœåŠ¡å™¨éƒ¨ç½²é…ç½®æ–‡æ¡£.mdã€‹** - è¯¦ç»†çš„æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤
- **ã€Šå¼€å‘éƒ¨ç½²å·¥ä½œæµ.mdã€‹** - Gitå·¥ä½œæµç¨‹
- **ã€ŠFlutterå®¢æˆ·ç«¯é›†æˆå®Œæˆ.mdã€‹** - å®¢æˆ·ç«¯é›†æˆæŒ‡å—

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼æœ‰é—®é¢˜éšæ—¶æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»æ”¯æŒã€‚** ğŸš€
