# 《日常教练》软件架构

> 目标：以 Flutter 客户端为核心，提供多维记录、夜间复盘、AI 明日计划、趋势统计与设置管理的完整体验，确保系统在可扩展性、灵活性、完整性、安全性和可复用性上可持续演进。

---

## 1. 架构目标与约束

1. **业务闭环**：支持 PRD 中的九大模块（账号、首页、记录、复盘、明日计划、统计、复盘历史、设置、数据导出），保障用户从注册到复盘的主流程畅通。
2. **体验轻量**：客户端操作路径 ≤2 步完成记录，首页首屏渲染 <2s，记录/复盘失败时提供离线与重试策略。
3. **AI 能力融合**：对接图像识别与大语言模型，支持结构化饮食解析、复盘报告、明日计划生成。
4. **多端一致**：Flutter 同时交付 iOS/Android/Web（渐进式），共享业务层逻辑，UI 组件库具备可复用性。
5. **安全合规**：账号体系与数据传输遵循国密/HTTPS，隐私数据（健康、读书记录）需加密存储和访问控制。
6. **可运维性**：提供日志、监控、崩溃收集、CI/CD、灰度机制，保证快速定位问题与迭代。

---

## 2. 架构原则

- **分层解耦**：Presentation / Application / Domain / Data 分层，UI 与业务逻辑、数据访问、第三方依赖彻底隔离。
- **模块化与关注点分离**：按业务域（Auth、Onboarding、Dashboard、Records、Review、Stats、Settings 等）拆包，组件和状态管理在 feature 内闭环。
- **单向数据流**：借助 Riverpod + StateNotifier，事件自上而下、状态自下而上，便于调试和回溯。
- **离线优先**：记录类操作默认写本地缓存并标记 `pendingSync`，网络恢复后自动补发。
- **可测试**：UseCase、Repository、State 层均可注入 mock；关键流程具备单测/集成测试。
- **安全默认**：所有 API 走统一网关，敏感信息最小可见原则，客户端存储加密。

---

## 3. 整体系统蓝图（逻辑视图）

```
[Flutter App]
  ├─ Presentation (Widget / Router / Theme / i18n)
  ├─ Application (StateNotifier / Controller / Form)
  ├─ Domain (Entities / Value Object / UseCase)
  ├─ Data (Repository & DataSource: Local + Remote)
  └─ Services (Media, Notification, Analytics, AI Adapter)

[API Gateway / Backend]
  ├─ Auth Service（手机号 + 验证码，JWT/OAuth）
  ├─ DayLog Service（运动/饮食/睡眠/工作/读书记录 CRUD）
  ├─ Review Service（夜间复盘、明日计划）
  ├─ Stats Service（周/月趋势、AI 总结缓存）
  ├─ File Service（上传饮食图像/语音）
  └─ Config Service（目标、通知、AI 风格）

[AI 能力]
  ├─ LLM Service（复盘报告、明日计划、读书总结）
  └─ Image Service（饮食识别）

[Observability]
  ├─ 日志/埋点/分析
  ├─ Crash 收集（Firebase Crashlytics/Sentry）
  └─ 推送服务（FCM/APNs/本地通知）
```

数据流：Flutter 通过 Repository 调用 REST/gRPC → API Gateway → 后端服务 →（若需）调用 LLM/Image → 返回结构化 JSON → 本地缓存/渲染。离线状态下仅本地操作，待网络恢复后同步。

---

## 4. Flutter 客户端架构

### 4.1 目录规划

```
lib/
 ├─ app/
 │   ├─ app.dart / bootstrap.dart
 │   ├─ router/ (go_router 配置、守卫)
 │   ├─ theme/ (颜色、组件、暗色模式)
 │   └─ localization/
 ├─ core/
 │   ├─ constants / errors / extensions / utils
 │   ├─ network/ (dio client, interceptors, retry)
 │   ├─ storage/ (Isar/Hive, secure storage)
 │   └─ logging/analytics adapters
 ├─ shared/
 │   ├─ widgets/（卡片、按钮、BottomSheet、Dialog、图表）
 │   ├─ forms & validation
 │   └─ mixins/hooks（如 `PendingSyncMixin`）
 └─ features/
     ├─ auth/
     ├─ onboarding/
     ├─ dashboard/ (今日概览 + DayLog)
     ├─ records/ (运动/饮食/睡眠/工作/读书)
     ├─ review/ (夜间复盘、明日计划)
     ├─ stats/
     ├─ settings/
     └─ profile/
```

每个 feature 下再分：

```
presentation/ (pages, widgets, controllers)
application/  (state_notifier, form service)
domain/       (entities, repositories, usecases)
data/         (dto, local_ds, remote_ds, repository impl)
```

### 4.2 关键技术选型

| 能力              | 选型/策略 |
| ----------------- | --------- |
| 状态管理          | `flutter_riverpod` + `StateNotifier`/`AsyncNotifier`，ProviderScope 统一依赖注入 |
| 路由              | `go_router`（ShellRoute + 子路由），支持深链、拦截（未登录、复盘未完成） |
| 网络              | `dio` + 自定义拦截器（鉴权、重试、日志） + `retrofit` 生成 API |
| 序列化            | `json_serializable` + `freezed`（不可变数据类型） |
| 本地存储          | `isar`（结构化数据） + `flutter_secure_storage`（token/隐私设置） |
| 多媒体            | `camera`, `image_picker`, `speech_to_text`（按需） |
| UI 架构           | 设计系统 + 自定义 Theme + 组件库（配色/渐变/阴影/状态） |
| Testing           | `flutter_test`, `mocktail`, `integration_test`, `golden_toolkit` |

### 4.3 核心流程

1. **快速记录**：BottomSheet 收集输入 → Application 层校验 → UseCase 写本地缓存 → 触发同步任务 → UI 监听状态更新（成功/失败/pending）。
2. **饮食拍照**：进入 DietCamera 子路由 → 拍照上传 → Remote DS 调用图像识别 → 回填食物列表，允许用户调整后保存。
3. **夜间复盘**：本地通知唤醒 → 复盘页面加载 DayLog 概览 → 用户回答问题 → UseCase 组装 Prompt 调 LLM → 预览/编辑 → 保存 DayLog + 触发明日计划 UseCase。
4. **统计**：查询后端聚合数据 + 本地缓存，绘制折线/柱状/得分卡片，支持日期范围选择。
5. **离线同步**：`PendingSyncQueue` 监听网络状态（connectivity_plus），定期读取本地待同步记录调用 Remote DS，失败回退并显示 Toast。

---

## 5. 后端与外部服务协同（概述）

- **Auth Service**：手机号 + 验证码登录，STS 获取 JWT/Refresh Token；客户端定期刷新，Secure Storage 存储。
- **DayLog/Record Service**：提供 CRUD、批量查询、分页；具备乐观锁或版本号防止数据冲突。
- **AI Orchestrator**：封装与 LLM、图像识别的交互，统一 Prompt 模板、重试与费用控制；下游通过 Webhook/轮询返回结果。
- **Notification Service**：统一配置夜间复盘提醒、目标提醒，支持远端配置 + 本地容灾。
- **Config & Settings**：管理目标、AI 风格、隐私偏好；客户端通过缓存 + ETag 减少请求。

> 虽然当前重点在 Flutter 前端，但前端模块以接口协议驱动，可方便对接自研或第三方后端。

---

## 6. 数据模型与同步策略

- **DayLog（每日汇总）**：包含 `date`, `scores`, `summary`, `aiDailySummary`, `aiTomorrowPlan`, `reviewStatus` 等字段。
- **记录实体（Workout, Meal, Sleep, WorkLog, Reading）**：统一字段 `id`, `userId`, `day`, `source`, `pendingSync`, `createdAt`.
- **缓存策略**：`isar` 中以 `day` 为键存储 DayLog 与维度记录；`pendingSync` 标记 + `syncAttempt` + `lastError`.
- **同步机制**：
  1. 写本地 → 标记 `pendingSync`.
  2. Sync Worker 依据网络/电量策略批量发送。
  3. 成功后更新 `pendingSync=false`、回写服务端 `serverId`.
  4. 冲突处理：若服务端返回版本冲突，拉取最新数据并提示用户选择覆盖或合并。

---

## 7. 安全与隐私

- **传输安全**：所有 API 采用 HTTPS + HSTS；图像/语音上传走安全通道，采用临时上传凭证。
- **身份与会话**：JWT + Refresh Token，客户端 Secure Storage 保存并定期刷新；登出时清空本地敏感数据。
- **数据加密**：本地使用 `flutter_secure_storage` 存放 token、个人信息；Isar 数据库可启用加密密钥。
- **权限控制**：前端严格校验用户登录状态，敏感页面（统计、导出）需重新验证；后端基于 userId 隔离。
- **隐私控制**：提供隐私/数据页（导出、删除、撤回授权），记录用户操作日志；遵循最小化收集原则。

---

## 8. 可扩展性、灵活性与可复用性考量

1. **模块化包管理**：未来可引入 Melos/Flutter Package，将 features 拆为多 package，支持多团队协作。
2. **跨平台共享**：Domain/UseCase/Repository 纯 Dart，实现 Web/桌面/服务端复用；UI 层依托 Flutter 适配多端。
3. **AI 策略可插拔**：LLM/Image Service 通过接口注入，支持切换供应商或自建模型；Prompt 模板集中配置。
4. **配置化能力**：目标配置、提问模版、复盘提醒时间可通过远端配置服务下发，实现动态运营。
5. **组件库复用**：shared/widgets 中沉淀卡片、标签、图表、记录表单组件，可被不同 Feature 引用，降低重复开发。
6. **测试/监控**：标准化的测试与监控脚手架，方便未来新增模块快速接入。

---

## 9. 安全性、可靠性与性能评估

- **可靠性**：离线缓存 + 自动重试保障记录不丢失；关键流程提供草稿与回滚（夜间复盘、明日计划）。
- **性能**：首页使用 `Sliver`/`AsyncValue` 异步加载，图表懒加载，网络层启用 gzip/缓存；图像上传压缩。
- **可观测性**：埋点覆盖记录行为、复盘成功率、AI 调用耗时；Crashlytics/Sentry 监控异常。
- **容灾**：AI/图像服务失败时切换手动模式；API Gateway 出错时提供本地提示与重试。

---

## 10. DevOps & 质量保障

1. **CI/CD**：GitHub Actions/Bitrise 执行 `flutter format/analyze/test`、集成测试、打包（iOS/Android/Web）。
2. **环境管理**：Dev/QA/Prod 多环境配置（flavor），配置文件通过 `.env` + `flutter_dotenv` 注入。
3. **自动化测试**：
   - 单元：UseCase/Repository/State 管理；
   - Widget/Gesture：关键页面（首页、复盘、统计）；
   - Integration：注册→记录→复盘→计划完整链路；
   - Golden：核心组件（卡片、BottomSheet）。
4. **代码规范**：`analysis_options.yaml` 配合 `very_good_analysis`；pre-commit 钩子运行 lint/test。
5. **发布策略**：Beta/TestFlight + 内测通道；灰度发布 + 监控指标（留存、复盘完成率）决定放量。

---

## 11. 演进路线

1. **里程碑 M0**：完成 app/bootstrap、路由、主题、全局依赖注入，接入 mock 数据源。
2. **里程碑 M1**：实现 Auth + Onboarding + Dashboard + 快速记录（基础字段），并具备离线缓存。
3. **里程碑 M2**：接入夜间复盘、AI 明日计划、饮食拍照识别；完善统计模块。
4. **里程碑 M3**：上线设置/隐私/数据导出、明日计划提醒、复盘历史；补齐测试。
5. **里程碑 M4**：性能优化（列表虚拟化、图表缓存）、组件库沉淀、国际化、Web 支持。

---

## 12. 结论

该架构在分层解耦、模块化、离线能力、AI 集成与安全方面均具备清晰策略，能够支撑 PRD 所述功能并保持可扩展性。Riverpod + Clean 架构确保逻辑复用与测试友好，Repository + pendingSync 保障数据可靠性，外部服务接口化使后续扩展或替换供应商成本最小。整体方案经审校后满足可扩展性、灵活性、完整性、安全性、可复用性要求，可作为后续开发与协作的基线文档。
