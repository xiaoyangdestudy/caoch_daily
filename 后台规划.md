# 《日常教练》后台接入规划

> 目标：指导团队将 Flutter 客户端与云服务器后台完成初次对接，覆盖环境准备、后端架构、接口契约、客户端联调、安全与测试，确保落地过程可跟踪、可验证、可持续演进。

---

## 1. 目标与成功标准

1. **业务目标**：支撑登录、五维记录（运动/饮食/睡眠/工作/读书）、夜间复盘、AI 明日计划、统计总览、设置/目标等主流程。
2. **技术目标**：构建可扩展的后端服务集群（HTTP API + AI 协同 + 对象存储），提供完备监控、日志与自动化部署。
3. **成功标准**：
   - 客户端可通过 HTTPS 接口完成注册→记录→复盘→统计闭环；
   - 接口鉴权、速率限制、生效日志均落地；
   - 端到端测试脚本通过，错误率 <1%，核心接口延迟 <300ms（不含 AI）。

---

## 2. 云服务器与基础设施准备

| 项目 | 规划 |
| --- | --- |
| 云厂商与实例 | 选择主流云：阿里云/腾讯云/AWS；规格 ≥4C8G，50GB SSD，含公网 IP；部署区域靠近主用户群 |
| 操作系统 | Ubuntu Server 22.04 LTS（或同级 LTS）；初始化完成后执行 `apt update && apt upgrade` |
| 安全加固 | 新建普通运维用户 + SSH Key 登录；启用防火墙，仅开放 22、80、443、应用端口；定期打补丁 |
| 运行时/容器 | 安装 Docker CE + Docker Compose（或 containerd + k8s）；准备 Node.js 20 / JDK 17 / Python 3.11 / Go 1.21 等所需运行时 |
| 域名与证书 | 解析 `api.caocheveryday.com` 至服务器；使用 Let’s Encrypt/云盾申请证书，部署在 Nginx/Traefik |
| 数据与存储 | PostgreSQL 15（主实例 + 自动备份）；Redis 7（缓存/队列）；对象存储（OSS/COS/S3）负责文件/图片 |
| 监控与日志 | 安装 Prometheus Node Exporter、cAdvisor；日志统一写入 Loki/ELK；关键报警接入企业微信/飞书 |

---

## 3. 后端架构蓝图

1. **技术栈**：推荐 Node.js + NestJS（TypeScript）；备选 Spring Boot 3（Kotlin/Java）或 FastAPI（Python）。统一采用 REST + JSON。
2. **模块划分**：
   - `auth-service`：注册、登录、短信验证码、Token 策略；
   - `daylog-service`：每日总览、维度记录 CRUD、同步状态；
   - `ai-service`：夜间复盘、明日计划、读书总结（封装 LLM 调用）；
   - `stats-service`：周/月聚合、AI 总结缓存；
   - `file-service`：上传凭证、回调；
   - `config-service`：目标、通知、AI 风格配置。
3. **部署拓扑**：使用 Docker Compose（或 Helm/K8s）部署 `gateway (Nginx/Traefik)` + `app` + `db` + `redis` + `workers`。后续按模块拆容器。
4. **数据流**：Flutter → HTTPS → API Gateway → Service → DB/Redis →（若需）AI Provider → 回写响应；异步任务通过队列+Worker 处理。

---

## 4. 数据模型与接口规划

1. **核心数据表**（示例）：
   - `users`（账号信息、加盐哈希密码、手机号/邮箱、状态）；
   - `sessions`（Refresh Token、设备信息、过期时间）；
   - `day_logs`（日期、综合评分、AI 报告、状态）；
   - `workouts/meals/sleeps/work_notes/readings`（各维度记录，与 `day_logs` 关联）；
   - `ai_tasks`（任务类型、输入、结果、状态、LLM token 统计）；
   - `targets/settings/notifications`（目标值、提醒配置、隐私选项）。
2. **接口契约**：
   - `POST /api/v1/auth/register/login/refresh/logout`；
   - `GET/POST/PUT/DELETE /api/v1/records/{dimension}`；
   - `GET/PUT /api/v1/day-logs/{date}`；
   - `POST /api/v1/ai/review`、`POST /api/v1/ai/tomorrow-plan`（异步：立即返回任务 ID，客户端轮询 `/ai/tasks/{id}`）；
   - `GET /api/v1/stats/weekly|monthly`；
   - `PUT /api/v1/settings/targets`、`PUT /api/v1/settings/notifications`；
   - `POST /api/v1/files/presign`（获取上传 URL）。
3. **契约管理**：使用 OpenAPI 3.1（Swagger）描述请求/响应/错误码；生成 SDK/Mock；每次变更通过 CI 校验兼容性。

---

## 5. 部署与运维策略

1. **配置管理**：`.env`（仅服务器可见）存放数据库、Redis、JWT、AI Key；使用 Vault/KMS 管理密钥。
2. **CI/CD 流程**：
   - `lint → test → build image → push registry → deploy`；
   - GitHub Actions/ GitLab CI 触发，部署节点执行 `docker compose pull && docker compose up -d`.
3. **API Gateway**：Nginx/Traefik 负责 TLS 终止、路由、限流、压缩、WebSocket/SSE 支持；启用 Access/Error 日志。
4. **可观测性**：
   - 业务日志使用 JSON，采集到 Loki/Elastic；
   - Prometheus 监控接口延迟、QPS、错误率、AI token 消耗、CPU/内存；
   - 告警：接口错误率>2%、AI 失败率>5%、机器资源>80% 持续5分钟。

---

## 6. Flutter 客户端接入路径

1. **环境切换**：新增 `lib/shared/config/app_environment.dart`，通过 `--dart-define` 传递 `API_BASE_URL`、`AI_POLL_INTERVAL` 等参数。
2. **网络层改造**：
   - `dio` 全局实例 + 拦截器（Token 注入、日志、错误映射）；
   - 401 自动刷新 Token（调用 `/auth/refresh`），失败则跳转登录；
   - HTTPS 证书校验，可选证书 Pinning。
3. **数据层实现**：
   - `RemoteDataSource` 调用后端 REST；
   - `RepositoryImpl` 聚合远端与本地 `isar`；
   - `pendingSync`、`syncAttempt` 字段用于离线补偿。
4. **AI 任务处理**：
   - 提交任务 → 获取任务 ID → `Riverpod` 定时轮询或订阅 SSE → 更新 `AsyncValue`；
   - 失败时提示重试/降级模板。
5. **异常与重试**：统一错误码映射（网络错误、验证失败、限流、服务器错误）；UI 提供 toast/snackbar + 重试按钮。

---

## 7. 安全、隐私与合规

1. **传输安全**：全站 HTTPS，启用 HTTP Strict Transport Security；禁止 HTTP 明文。
2. **身份安全**：JWT + Refresh Token，私钥保存在服务器；刷新频率 30 分钟，Refresh 有效期 7 天。
3. **访问控制**：所有接口校验 userId；敏感操作（删除数据、导出）要求二次确认并写审计日志。
4. **数据保护**：本地敏感数据存 `flutter_secure_storage`；服务器数据库开启加密存储与自动备份；对象存储设置私有读写 + 临时凭证。
5. **速率限制**：Nginx + Redis 令牌桶，防止暴力破解或滥用；验证码接口增加图形/短信频控。
6. **合规**：记录隐私政策版本；支持用户数据导出与删除；AI 请求仅传递必要字段。

---

## 8. 测试与验收清单

1. **后端**：
   - 单元测试覆盖 UseCase/Service；
   - 集成测试通过 `docker compose run` 拉起依赖并执行；
   - 合约测试：使用 `schemathesis` 或 `openapi-diff` 确认兼容。
2. **客户端**：
   - `flutter test` 覆盖 entity、repository、StateNotifier；
   - Widget 测试（首页、记录表单、夜间复盘）；
   - 集成测试（自动化脚本跑注册→记录→复盘→统计）。
3. **联调**：
   - Postman/Thunder Client 套件与环境变量共享；
   - 每个接口记录示例、错误码、边界场景。
4. **性能/稳态**：
   - k6/JMeter 压测核心接口（QPS≥100 时延<300ms）；
   - AI 接口统计 token 消耗，确保配额足够；
   - 灰度发布观察崩溃率、接口错误率、AI 成功率 ≥95%。

---

## 9. 里程碑规划（建议）

1. **M0（第 1 周）**：云服务器初始化、技术栈确定、数据库 ER 图、OpenAPI 草稿。
2. **M1（第 2~3 周）**：完成 Auth + DayLog + Records API，Flutter 接通鉴权与记录 CRUD，联调打通。
3. **M2（第 4~5 周）**：上线 AI 服务、统计聚合、文件上传；客户端接入复盘/计划与统计模块。
4. **M3（第 6 周）**：安全加固（限流、日志、证书）、CI/CD、监控报警；灰度发布内测。
5. **M4（第 7 周）**：性能优化、问题修复、正式上线；输出运维手册与回滚策略。

---

## 10. 风险与预案

| 风险 | 影响 | 预案 |
| --- | --- | --- |
| AI 服务不稳定 | 复盘/计划失败率升高 | 建立重试 + 缓存最后一次成功结果；提供模板化 fallback |
| 接口变更影响客户端 | 线上崩溃或数据错乱 | 使用版本化 API + Feature Flag；联调脚本回归 |
| 服务器单点故障 | 服务不可用 | 启用云数据库高可用，准备热备或多区部署；配置自动备份与灾备演练 |
| 数据一致性问题 | 用户记录丢失/重复 | 本地 `pendingSync` + 服务端乐观锁；失败入队重放 |
| 安全入侵 | 数据泄露 | 最小权限、日志审计、WAF、防火墙、依赖漏洞扫描（Trivy/Snyk） |

---

## 11. 下一步行动

1. 确认云资源与技术栈，完成 M0 输出（ER 图 + OpenAPI 草稿 + 部署脚本雏形）。
2. 在仓库中新增后端目录或独立仓库，搭建基础框架并接入 CI。
3. Flutter 侧同时启动网络层重构与环境配置，确保后端接口上线后即可联调。
4. 预订后续周会，跟踪里程碑进度、风险与指标，及时复盘并优化流程。

> 以上规划是初版基线，可在执行中依据真实反馈迭代。每次阶段结束务必复盘：完成情况、遇到问题、优化建议，持续提升交付效率与质量。

